=pod

=head1 NAME

cmpClient - client for the Certificate Management Protocol (RFC4210)

=head1 SYNOPSIS

B<cmpClient> (B<imprint|bootstrap|update|revoke|pkcs10>) [B<-section> I<CA>]

B<cmpClient> I<options>

[B<-help>]
[B<-config> I<filename>]
[B<-section> I<names>]

[B<-server> I<address[:port]>]
[B<-proxy> I<[http://]address[:port][/path]>]
[B<-no_proxy> I<addresses>]
[B<-path> I<remote_path>]
[B<-msgtimeout> I<seconds>]
[B<-totaltimeout> I<seconds>]

[B<-trusted> I<filenames>]
[B<-untrusted> I<sources>]
[B<-srvcert> I<filename>]
[B<-recipient> I<name>]
[B<-expect_sender> I<name>]
[B<-ignore_keyusage>]
[B<-unprotectederrors>]
[B<-extracertsout> I<filename>]
[B<-cacertsout> I<filename>]

[B<-ref> I<value>]
[B<-secret> I<arg>]
[B<-cert> I<filename>]
[B<-key> I<filename>]
[B<-keypass> I<arg>]
[B<-digest> I<name>]
[B<-mac> I<name>]
[B<-extracerts> I<sources>]
[B<-unprotectedrequests>]

[B<-cmd> I<ir|cr|kur|p10cr|rr>]
[B<-infotype> I<name>]
[B<-geninfo> I<OID>:int:I<N>]

[B<-newkeytype> EC:I<curve>|RSA-I<len>]
[B<-newkey> I<filename>]
[B<-newkeypass> I<arg>]
[B<-subject> I<name>]
[B<-issuer> I<name>]
[B<-days> I<number>]
[B<-reqexts> I<name>]
[B<-sans> I<spec>]
[B<-san_nodefault>]
[B<-policies> I<name>]
[B<-policy_oid> I<names>]
[B<-policy_oids_critical>]
[B<-popo> I<number>]
[B<-csr> I<filename>]
[B<-out_trusted> I<filenames>]
[B<-verify_hostname> I<cn>]
[B<-verify_ip> I<ip>]
[B<-verify_email> I<email>]
[B<-implicitconfirm>]
[B<-disableconfirm>]
[B<-certout> I<filename>]

[B<-oldcert> I<filename>]
[B<-revreason> I<number>]

[B<-tls_used>]
[B<-tls_cert> I<filename>]
[B<-tls_key> I<filename>]
[B<-tls_keypass> I<arg>]
[B<-tls_extra> I<filenames>]
[B<-tls_trusted> I<filenames>]
[B<-tls_host> I<name>]

[B<-verbosity> I<level>]

[B<-check_all>]
[B<-check_any>]
[B<-crls> I<URLs>]
[B<-use_cdp>]
[B<-cdps> I<URLs>]
[B<-crls_timeout> I<seconds>]
[B<-use_aia>]
[B<-ocsp> I<URLs>]
[B<-ocsp_timeout> I<seconds>]
[B<-ocsp_last>]
[B<-stapling>]


=head1 DESCRIPTION

The B<cmpClient> command is a demo and test client implementation for the Certificate
Management Protocol (CMP) as defined in RFC 4210.
It can be used to request certificates from a CA server,
update their certificates,
request certificates to be revoked, and perform other CMP requests.


=head1 USAGE

=over 4

=item B<imprint|bootstrap|update|revoke|pkcs10>

Select demo C<use_case> of the cmpClient application. The corresponding CMP request
will be executed with default settings. These settings could be adapt via the
file 'config/demo.cnf'.

=item List of options available for the C<cmpClient> application:

=back


=head1 OPTIONS

=over 4

=item B<-help>

Display a summary of all options

=item B<-config> I<filename>

Configuration file to use.
An empty string C<""> means none.
Default filename is C<config/demo.cnf>.

=item B<-section> I<names>

Section(s) to use within config file defining CMP options.
An empty string C<""> means no specific section.
Default is C<default>.
Multiple section names may be given, separated by commas and/or whitespace.
Contents of sections named later may override contents of sections named before.
In any case, as usual, the C<[default]> section and finally the unnamed
section (as far as present) can provide per-option fallback values.

=back


=head2 Message transfer options

=over 4

=item B<-server> I<address[:port]>

The IP address or DNS hostname and optionally port (defaulting to 80)
of the CMP server to connect to using HTTP/S transport.

=item B<-proxy> I<[http://]address[:port][/path]>

The HTTP(S) proxy server to use for reaching the CMP server unless B<no_proxy>
applies, see below.
The optional "http://" prefix and any trailing path are ignored.
Defaults to the environment variable C<http_proxy> if set, else C<HTTP_PROXY>
in case no TLS is used, otherwise C<https_proxy> if set, else C<HTTPS_PROXY>.

=item B<-no_proxy> I<addresses>
List of IP addresses and/or DNS names of servers not use an HTTP(S) proxy for,
separated by commas and/or whitespace.
Default is from the environment variable C<no_proxy> if set, else C<NO_PROXY>.

=item B<-path> I<remote_path>

HTTP path at the CMP server (aka CMP alias) to use for POST requests.
Defaults to "/".

=item B<-msgtimeout> I<seconds>

Number of seconds (or 0 for infinite) a CMP message round trip is
allowed to take before a timeout error is returned.
Default is 120.

=item B<-totaltimeout> I<seconds>

Maximum number seconds an enrollment may take, including attempts polling for
certificates on C<waiting> PKIStatus.
Default is 0 (infinite).

=back


=head2 Server authentication options

=over 4

=item B<-trusted> I<filenames>

When verifying signature-based protection of CMP response messages,
use a trust store containing the given certificate(s) as trusted
while verifying certificates during CMP server authentication.
This option gives more flexibility than the B<-srvcert> option because
it does not pin down the expected CMP server by allowing only one certificate.

Multiple filenames may be given, separated by commas and/or whitespace.
Each source may contain multiple certificates.

=item B<-untrusted> I<sources>

Non-trusted intermediate certificate(s) that may be useful
for building certificate chains when verifying
the CMP server (when checking signature-based CMP message protection),
the own TLS client cert (when constructing the TLS client cert chain),
stapled OCSP responses (when establishing TLS connections),
and/or the newly enrolled certificate.
These may get added to the extraCerts field sent in requests as far as needed.

Multiple filenames may be given, separated by commas and/or whitespace.
Each file may contain multiple certificates.

=item B<-srvcert> I<filename>

The specific CMP server certificate to use and directly trust (even if it is
expired) when verifying signature-based protection of CMP response messages.
May be set alternatively to the B<-trusted> option
if the certificate is available and only this one shall be accepted.

If set, the issuer of the certificate is also used as the recipient of the CMP
request and as the expected sender of the CMP response,
overriding any potential B<-recipient> option.

=item B<-recipient> I<name>

Distinguished Name (DN) of the CMP message recipient,
i.e., the CMP server (usually a CA or RA entity).

The argument must be formatted as I</type0=value0/type1=value1/type2=...>,
characters may be escaped by C<\>E<nbsp>(backslash), no spaces are skipped.

If a CMP server certificate is given with the B<-srvcert> option, its subject
name is taken as the recipient name and the B<-recipient> option is ignored.
If neither of the two are given, the recipient of the PKI message is
determined in the following order: from the B<-issuer> option if present,
the issuer of old cert given with the B<-oldcert> option if present,
the issuer of the client certificate (B<-cert> option) if present.

Setting the recipient field in the CMP header is mandatory.
If none of the above options allowing to derive the recipient name is given,
no suitable value for the recipient in the PKIHeader is available.
As last resort it is set to NULL-DN.

When a response is received, its sender must match the recipient of the request.

=item B<-expect_sender> I<name>

Distinguished Name (DN) of the expected sender of CMP response messages when
MSG_SIG_ALG is used for protection.
This can be used to ensure that only a particular entity is accepted
to act as CMP server, and attackers are not able to use arbitrary certificates
of a trusted PKI hieararchy to fraudulently pose as CMP server.
Note that this option gives slightly more freedom than B<-srvcert>,
which pins down the server to a particular certificate,
while B<-expect_sender> I<name> will continue to match after updates of the
server cert.

The argument must be formatted as I</type0=value0/type1=value1/type2=...>,
characters may be escaped by C<\>E<nbsp>(backslash), no spaces are skipped.

If not given, the subject DN of B<-srvcert>, if provided, will be used.

=item B<-ignore_keyusage>

Ignore key usage restrictions in CMP signer certificates when verifying
signature-based protection of incoming CMP messages,
else C<digitalSignature> must be allowed for signer certificate.

=item B<-unprotectederrors>

Accept missing or invalid protection of negative responses from the server.
This applies to the following message types and contents:

=over 4

=item * error messages

=item * negative certificate responses (IP/CP/KUP)

=item * negative revocation responses (RP)

=item * negative PKIConf messages

=back

B<WARNING:> This setting leads to unspecified behavior and it is meant
exclusively to allow interoperability with server implementations violating
RFC 4210, e.g.:

=over 4

=item * section 5.1.3.1 allows exceptions from protecting only for special
cases:
"There MAY be cases in which the PKIProtection BIT STRING is deliberately not
used to protect a message [...] because other protection, external to PKIX, will
be applied instead."

=item * section 5.3.21 is clear on ErrMsgContent: "The CA MUST always sign it
with a signature key."

=item * appendix D.4 shows PKIConf having protection

=back

=item B<-extracertsout> I<filename>

The file where to save any extra certificates received in the extraCerts field
of response messages.

=item B<-cacertsout> I<filename>

The file where to save any CA certificates received in the caPubs field of
initializiation response (ip) messages.

=back


=head2 Client authentication options

=over 4

=item B<-ref> I<value>

Reference number/string/value to use as fallback senderKID; this is required
if no sender name can be determined from the B<-cert> or <-subject> options and
is typically used when authenticating with pre-shared key (password-based MAC).

=item B<-secret> I<arg>

Source of secret value to use for creating PBM-based protection of outgoing
messages and for verifying any PBM-based protection of incoming messages.
PBM stands for Password-Based Message Authentication Code.
This takes precedence over the B<-cert> option.

Currently only plain passwords are supported,
which should be preceded by "pass:".

=item B<-cert> I<filename>

The client's current certificate.
Requires for the corresponding key to be given with B<-key>.
The subject of this certificate will be used as the "sender" field
of outgoing CMP messages, while B<-subjectName> may provide a fallback value.
When using signature-based message protection, this "protection certificate"
will be included first in the extraCerts field of outgoing messages.
For IR this can be used for authenticating a request message
using an external entity certificate as defined in appendix E.7 of RFC 4210.
For KUR this is also used as certificate to be updated if the B<-oldcert>
option is not given.
If the file includes further certs, they are appended to the untrusted certs.
These may get added to the extraCerts field sent in requests as far as needed.

=item B<-key> I<filename>

The corresponding private key file for the client's current certificate given in
the B<-cert> option.
This will be used for signature-based message protection
unless the B<-secret> option indicating PBM or B<-unprotectedrequests> is given.

=item B<-keypass> I<arg>

Pass phrase source for the private key given with the B<-key> option.
Also used for B<-cert> and B<-oldcert> in case it is an encrypted PKCS#12 file.
If not given here, the password will be prompted for if needed.

Currently only plain passwords are supported,
which should be preceded by "pass:".

=item B<-digest> I<name>

Specifies name of supported digest to use in RFC 4210's MSG_SIG_ALG
and as the one-way function (OWF) in MSG_MAC_ALG.
If applicable, this is used for message protection and
Proof-of-Possession (POPO) signatures.
To see the list of supported digests, use B<openssl list -digest-commands>.
Defaults to C<sha256>.

=item B<-mac> I<name>

Specifies name of supported digest to use as the MAC algorithm in MSG_MAC_ALG.
To get the names of supported MAC algorithms use B<openssl list -mac-algorithms>
and possibly combine such a name with the name of a supported digest algorithm,
e.g., hmacWithSHA256.
Defaults to C<hmac-sha1> as per RFC 4210.

=item B<-extracerts> I<sources>

Certificates to append in the extraCerts field when sending messages.

Multiple filenames or URLs may be given, separated by commas and/or whitespace.
Each source may contain multiple certificates.

=item B<-unprotectedrequests>

Send messages without CMP-level protection.

=back


=head2 Generic message options

=over 4

=item B<-cmd> I<ir|cr|kur|p10cr|rr>

CMP command to execute. Overrides C<use_case> if present.
Currently implemented commands are:

=over 8

=item  ir E<nbsp>  - Initialization Request

=item  cr E<nbsp>  - Certificate Request

=item  p10cr - PKCS#10 Certification Request (for legacy support)

=item  kur E<nbsp>E<nbsp>- Key Update Request

=item  rr E<nbsp>  - Revocation Request

=back

B<ir> requests initialization of an End Entity into a PKI hierarchy by means of
issuance of a first certificate.

B<cr> requests issuance of an additional certificate for an End Entity already
initialized to the PKI hierarchy.

B<p10cr> requests issuance of an additional certificate similarly to B<cr>
but uses PKCS#10 CSR format.

B<kur> requests (key) update for an existing, given certificate.

B<rr> requests revocation of an existing, given certificate.

=item B<-infotype> I<name>

Set InfoType name to use for requesting specific info in B<genm>,
e.g., C<signKeyPairTypes>.

=item B<-geninfo> I<OID>:int:I<N>

generalInfo integer values to place in request PKIHeader with given OID,
e.g., C<1.2.3:int:987>.

=back


=head2 Certificate enrollment options

=over 4

=item B<-newkeytype> I<spec>

In case of IR, CR, or KUR,
generate a new key of the given type for the requested certifiate.
The I<spec> may be of the form "EC:I<curve>" or "RSA-I<length>".
The key will be saved in the file specified with the B<-newkey> option.

=item B<-newkey> I<filename>

The file to save the newly generated key (in case  B<-newkeytype> is given).
Otherwise the file to read the private or public key from
for the certificate requested in IR, CR or KUR.
Default is the current client key, if given.

=item B<-newkeypass> I<arg>

Pass phrase source for the key file given with the B<-newkey> option.
If not given here, the password will be prompted for if needed.

Currently only plain passwords are supported,
which should be preceded by "pass:".

=item B<-subject> I<name>

X509 Distinguished Name (DN) of subject to use in the requested certificate
template.
For KUR, it defaults to the subject DN of the reference certificate
(see B<-oldcert>).
This default is used for IR and CR only if no SANs are set.

The argument must be formatted as I</type0=value0/type1=value1/type2=...>,
characters may be escaped by C<\>E<nbsp>(backslash), no spaces are skipped.

In case B<-cert> is not set, for instance when using MSG_MAC_ALG,
the subject DN is also used as sender of the PKI message.

=item B<-issuer> I<name>

X509 issuer Distinguished Name (DN) of the CA server
to place in the requested certificate template in IR/CR/KUR.

The argument must be formatted as I</type0=value0/type1=value1/type2=...>,
characters may be escaped by C<\>E<nbsp>(backslash), no spaces are skipped.

If neither B<-srvcert> nor B<-recipient> is available,
the name given in this option is also set as the recipient of the CMP message.

=item B<-days> I<number>

Number of days the new certificate is requested to be valid for, counting from
the current time of the host.
Also triggers the explicit request that the
validity period starts from the current time (as seen by the host).

=item B<-reqexts> I<name>

Name of section in OpenSSL config file defining certificate request extensions.

=item B<-sans> I<spec>

One or more IP addresses, DNS names, or URIs separated by commas or whitespace,
to add as Subject Alternative Name(s) (SAN) certificate request extension.
If the special element "critical" is given the SANs are flagged as critical.
Cannot be used if any Subject Alternative Name extension is set via B<-reqexts>.

=item B<-san_nodefault>

When Subject Alternative Names are not given via B<-sans>
nor defined via B<-reqexts>,
they are copied by default from the reference certificate (see B<-oldcert>).
This can be disabled by giving the B<-san_nodefault> option.

=item B<-policies> I<name>

Name of section in OpenSSL config file defining policies to be set
as certificate request extension.
This option cannot be used together with B<-policy_oids>.

=item B<-policy_oids> I<names>

One or more OID(s), separated by commas and/or whitespace,
to add as certificate policies request extension.
This option cannot be used together with B<-policies>.

=item B<-policy_oids_critical>

Flag the policies given with B<-policy_oids> as critical.

=item B<-popo> I<number>

Proof-of-Possession (POPO) method to use for IR/CR/KUR; values: C<-1>..<2> where
C<-1> = NONE, C<0> = RAVERIFIED, C<1> = SIGNATURE (default), C<2> = KEYENC.

Note that a signature-based POPO can only produced if a private key
is provided via the B<-newkey> or B<-key> options.

=item B<-csr> I<filename>

CSR in PKCS#10 format to use in P10CR.
This is for supporting legacy clients.

=item B<-out_trusted> I<filenames>

Trusted certificate(s) to use for verifying the newly enrolled certificate.

Multiple filenames may be given, separated by commas and/or whitespace.
Each source may contain multiple certificates.

=item B<-verify_hostname> I<name>

When verification of the newly enrolled certificate is enabled (with the
B<-out_trusted> option), check if any DNS Subject Alternative Name (or if no
DNS SAN is included, the Common Name in the subject) equals the given B<name>.

=item B<-verify_ip> I<ip>

When verification of the newly enrolled certificate is enabled (with the
B<-out_trusted> option), check if there is
an IP address Subject Alternative Name matching the given IP address.

=item B<-verify_email> I<email>

When verification of the newly enrolled certificate is enabled (with the
B<-out_trusted> option), check if there is
an email address Subject Alternative Name matching the given email address.

=item B<-implicitconfirm>

Request implicit confirmation of newly enrolled certificates.

=item B<-disableconfirm>

Do not send certificate confirmation message for newly enrolled certificate
without requesting implicit confirmation
to cope with broken servers not supporting implicit confirmation correctly.
B<WARNING:> This leads to behavior violating RFC 4210.

=item B<-certout> I<filename>

The file where the newly enrolled certificate should be saved.

=back


=head2 Certificate update and revocation options

=over 4

=item B<-oldcert> I<filename>

The certificate to be updated (i.e., renewed or re-keyed) in KUR
or to be revoked in RR.
It must be given for RR, else it defaults to B<-cert>.

The reference certificate determined in this way, if any, is also used for
deriving default subject DN and Subject Alternative Names for IR, CR, and KUR.
Its issuer, if any, is used as default recipient in the CMP message header
if neither B<-srvcert>, B<-recipient>, nor B<-issuer> is available.

=item B<-revreason> I<number>

Set CRLReason to be included in revocation request (RR); values: C<0>..C<10>
or C<-1> for none (which is the default).

Reason numbers defined in RFC 5280 are:

   CRLReason ::= ENUMERATED {
        unspecified             (0),
        keyCompromise           (1),
        cACompromise            (2),
        affiliationChanged      (3),
        superseded              (4),
        cessationOfOperation    (5),
        certificateHold         (6),
        -- value 7 is not used
        removeFromCRL           (8),
        privilegeWithdrawn      (9),
        aACompromise           (10)
    }

=back


=head2 TLS connection options

=over 4

=item B<-tls_used>

Enable using TLS (even when other TLS_related options are not set)
when connecting to CMP server.
The following TLS-related options are ignored if B<-tls_used> is not given.

=item B<-tls_cert> I<filename>

Client's TLS certificate.
If the file includes further certificates,
they are used for constructing the client cert chain provided to the TLS server.

=item B<-tls_key> I<filename>

Private key for the client's TLS certificate.

=item B<-tls_keypass> I<arg>

Pass phrase source for client's private TLS key B<tls_key>.
Also used for B<-tls_cert> in case it is an encrypted PKCS#12 file.
If not given here, the password will be prompted for if needed.

Currently only plain passwords are supported,
which should be preceded by "pass:".

=item B<-tls_extra> I<filenames>

Extra certificates to provide to TLS server during TLS handshake

=item B<-tls_trusted> I<filenames>

Trusted certificate(s) to use for verifying the TLS server certificate.
This implies hostname validation.

Multiple filenames may be given, separated by commas and/or whitespace.
Each source may contain multiple certificates.

=item B<-tls_host> I<name>

Address to be checked (rather than B<-server> address)
during TLS hostname validation.
This may be a Common Name, a DNS name, or an IP address.

=back


=head2 Debugging options

=over 4

=item B<-verbosity> I<level>

Level of verbosity for logging, error output, etc.
0 = EMERG, 1 = ALERT, 2 = CRIT, 3 = ERR, 4 = WARN, 5 = NOTE,
6 = INFO, 7 = DEBUG, 8 = TRACE.
Defaults to 6 = INFO.
The levels DEBUG and TRACE are most useful for certificate status check issues.

=back


=head2 Certificate status checking options, for both CMP and TLS

The following set of options determine various parameters of
certificate revocation status checking to be performed by the client
on setting up any TLS connection and on checking any signature-based protection
of CMP messages received, but not when verifying newly enrolled certificates.

By default no certificate status checks are performed.
Status checking is demanded if any of the below status checking options are set,
but only as far as a trust store is provided for TLS or at CMP level.
Then by default only the leaf certificates of a chain are checked, i.e.,
the certificates of CMP servers and of TLS servers (as far as TLS is used).
The options B<-check_all> and B<-check_any> may be used to change the extent
of the checks to futher elements in the CA chain of these certificates.

For each certificate for which the status check is demanded the
certification verification procedure will try to obtain the revocation status
first via OCSP stapling if enabled,
then from any locally available CRLs,
then from any Online Certificate Status Protocol (OCSP) responders if enabled,
and finally from CRLs downloaded from certificate distribution points (CDPs)
if enabled.
With the B<-ocsp_last> option CDPs are tried before trying OCSP.
Verification fails if no valid and current revocation status can be found
or the status indicates that the certificate has been revoked.

=over 4

=item B<-check_all>

Check certificate status not only for leaf certificates of a chain
but for all certificates (except root, i.e., self-issued certificates).

=item B<-check_any>

Check certificate status for those certificates (except root certificates)
that contain a CDP or AIA entry (or for which OCSP stapling for TLS is enabled).

=item B<-crls> I<URLs>

Enable CRL-based status checking and
use given CRL(s) as primary source of certificate revocation information.
The URLs argument may contain a single element or
a comma- or whitespace-separated list,
each element starting with C<http:> or C<file:> or being a filename or pathname.

=item B<-use_cdp>

Enable CRL-based status checking and
enable using CRL Distribution Points (CDP) extension entries in certificates.

=item B<-cdps> I<URLs>

Enable CRL-based status checking and
use the given URL(s) as fallback certificate distribution points (CDP).

=item B<-crls_timeout> I<seconds>

Number of seconds fetching a CRL may take, or 0 for infinite.
A negative value implies the default: 10 seconds.

=item B<-use_aia>

Enable OCSP-based status checking and
enable using Authority Information Access (AIA) OCSP responder entries
in certificates.

=item B<-ocsp> I<URLs>

Enable OCSP-based status checking and
use given OCSP responder URL(s) as fallback.

=item B<-ocsp_timeout> I<seconds>

Number of seconds getting an OCSP response may take, or 0 for infinite.
A negative value implies the default: 10 seconds.

=item B<-ocsp_last>

This option can be used only when OCSP-based checks are enabled using B<-ocsp>
or B<-use_aia>. If checks downloading CRLs from CDPs are also enabled
then do OCSP-based checks last (else before using CRLs downloaded from CDPs).

=item B<-stapling>

Enable the TLS certificate status request extension ("OCSP stapling"),
which is tried first before any other methods of certificate status checking.
This makes sense only if B<-tls_used> is given.
So far OCSP multi-stapling is not supported,
so status information can be obtained in this way only for the leaf certificate
(i.e., the TLS server certificate).

=back


=head2 Certificate validation options, for both CMP and TLS

=over 4

=item B<-policy>, B<-purpose>, B<-verify_name>, B<-verify_depth>,
B<-attime>,
B<-ignore_critical>,
B<-policy_check>,
B<-explicit_policy>, B<-inhibit_any>, B<-inhibit_map>,
B<-x509_strict>, B<-extended_crl>, B<-use_deltas>,
B<-policy_print>, B<-check_ss_sig>, B<-trusted_first>,
B<-suiteB_128_only>, B<-suiteB_128>, B<-suiteB_192>,
B<-partial_chain>,
B<-no_check_time>,
B<-auth_level>,
B<-allow_proxy_certs>

Set various options of certificate chain verification.
See the L<openssl-verify(1)> manual page
or L<openssl(1)/Verification Options> for details.

=back


=head1 COPYRIGHT

Copyright (c) 2020 Siemens AG.

Licensed under the Apache License, Version 2.0
SPDX-License-Identifier: Apache-2.0

=cut
